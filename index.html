<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>My first three.js app</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <script type="x-shader/x-vertex" id="vertexshader">

        varying vec2 vUv;

        void main() {

            vUv = uv;

            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

        }

    </script>

    <script type="x-shader/x-fragment" id="fragmentshader">

        uniform sampler2D baseTexture;
        uniform sampler2D bloomTexture;

        varying vec2 vUv;

        void main() {

            gl_FragColor = ( texture2D( baseTexture, vUv ) + vec4( 1.0 ) * texture2D( bloomTexture, vUv ) );

        }

    </script>

    <!-- Import maps polyfill -->
    <!-- Remove this when import maps will be widely supported -->
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>

    <script type="importmap">
			{
				"imports": {
					"three": "./build/three.module.js"
				}
			}
	</script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from './jsm/controls/OrbitControls.js';
        import Stats from './jsm/libs/stats.module.js';
        import { GUI } from './jsm/libs/lil-gui.module.min.js';
        import { OBJLoader } from './Loader/OBJLoader.js';
        import { MTLLoader } from './Loader/MTLLoader.js';
        import { FBXLoader } from './Loader/FBXLoader/FBXLoader.js';


        const scene = new THREE.Scene();

        /*--------相機--------*/
        const camera = new THREE.PerspectiveCamera(80, window.innerWidth / window.innerHeight, 0.1, 10000000);
        camera.position.set(3600, 5000, 13400);//初始的Camera位置
        // camera.position.set(-2022, 1421, 675);//初始的Camera位置
        camera.lookAt(0, 0, 0);

        /*--------renderer--------*/
        const renderer = new THREE.WebGLRenderer({
            antialias: true,
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        renderer.shadowMap.enabled = true;//把Renderer的陰影選項打開
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        /*--------背景顏色--------*/
        scene.background = new THREE.Color(0xffffff);

        /*--------移動視角--------*/
        let controls = new OrbitControls(camera, renderer.domElement);
        // controls.target.set(0, 0, 0);
        controls.enablePan = false;
        controls.maxPolarAngle = Math.PI / 2;
        controls.enableDamping = true;
        // controls.minDistance = 100;
        // controls.maxDistance = 1000;

        // /*-------Stats---------*/
        // const stats = Stats();
        // stats.showPanel(0);
        // // 0：FPS，最近1秒的幀率，值越大表示性能越好；
        // // 1：MS，每一幀需要多少毫秒，值越小表示性能越好；
        // // 2：MB，所分配的内存，開Google的時候要加參數
        // document.body.appendChild(stats.dom);

        /*--------OBJ模型-地板--------*/
        let objLoader = new OBJLoader();
        let mtlLoader = new MTLLoader();
        let url = "./models/2022-04-13-FINALTEST.mtl";
        let OBJMoudels;
        let plane;
        mtlLoader.load(url, function (materials) {
            materials.preload();
            objLoader.setMaterials(materials);
            OBJMoudels = objLoader.load('./models/2022-04-13-FINALTEST.obj', function (object) {
                object.traverse(function (node) {
                    if (node instanceof THREE.Mesh) {
                        node.castShadow = true; //default is false
                        // node.receiveShadow = false; //default
                        node.receiveShadow = true; //default
                    }
                })
                object.position.set(-7000, 0, -8200);//初始的Camera位置
                object.name = "plane";
                object.children[0].name = "plane";
                scene.add(object);
                plane = scene.getObjectByName("plane");
                // /*-------OBJ模型GUI---------*/
                // const gui = new GUI();
                // const model_position = gui.addFolder('model_position');
                // //資料夾名稱.add(要改變的東西,標題,最小值,最大值)
                // model_position.add(plane.position, 'x', -100000, 100000);
                // model_position.add(plane.position, 'y', -100000, 100000);
                // model_position.add(plane.position, 'z', -100000, 100000);
                // model_position.open();
            });

        });

        //FBX模型設定
        let FBX_name = ['group0',];
        let FBX_loader = ['loader0',];
        let FBX_url = [
            './models/2022-04-13-FINALTEST.fbx',
        ];

        //FBX匯入模組化
        function FBXimport(object_name, object_loader, object_url) {
            object_loader = new FBXLoader();
            object_loader.load(object_url, function (object1) {
                object_loader = new THREE.AnimationMixer(object1);
                object1.traverse(function (child) {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });
                object1.position.set(-7000, 0, -8200);
                object1.name = object_name;
                object1.children[0].name = object_name;
                scene.add(object1);
            });
            const group = scene.getObjectByName(object_name);

        }
        for (let i = 0; i < FBX_name.length; i++) {
            FBXimport(FBX_name[i], FBX_loader[i], FBX_url[i]);
            console.log(`模型${i}的name：${FBX_name[i]}`);
            console.log(`模型${i}的url：${FBX_name[i]}`);
        }

        /*--------燈光-AmbientLight--------*/
        let AmbientLight;
        AmbientLight = new THREE.AmbientLight(0xffffff, 1);
        scene.add(AmbientLight);

        /*--------燈光-PointLight--------*/
        const light1 = new THREE.PointLight(0xddffdd, 0.2);
        light1.position.z = 0;
        light1.position.y = 300;
        light1.position.x = 200;
        scene.add(light1);

        // /*-------相機GUI---------*/

        // const gui = new GUI();
        // const camera_position = gui.addFolder('camera_position');

        // //資料夾名稱.add(要改變的東西,標題,最小值,最大值)

        // camera_position.add(camera.position, 'x', -100000, 100000);
        // camera_position.add(camera.position, 'y', -100000, 100000);
        // camera_position.add(camera.position, 'z', -100000, 100000);
        // camera_position.open();



        //當遊覽器的視窗大小改變
        window.onresize = function () {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };

        function animate() {
            controls.update();
            // stats.update();
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        };
        animate();

    </script>
</body>

</html>